<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>Pokemon Card Tracker</title>
    <!-- Correctly links to the manifest.json file in your root folder -->
    <link rel="manifest" href="manifest.json">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        @media (display-mode: standalone) { body { padding-top: env(safe-area-inset-top); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- All your SVG Icons here ---
        const Camera = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg> );
        const Grid3x3 = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line></svg> );
        const Search = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg> );
        const X = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> );
        const Trash2 = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> );
        const Edit2 = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg> );
        const Check = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> );
        const Loader2 = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg> );
        const Sparkles = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg> );
        const ArrowLeft = ({ s=24, c="" }) => ( <svg className={c} width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg> );

        function PokemonCardTracker() {
            const [view, setView] = useState('collection');
            const [cards, setCards] = useState([]);
            const [showAddForm, setShowAddForm] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const [editingCard, setEditingCard] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [showPermissionModal, setShowPermissionModal] = useState(false);
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);
            const [selectedCard, setSelectedCard] = useState(null);
            const [ocrStatus, setOcrStatus] = useState('');
            const [formData, setFormData] = useState({ name: '', set: '', number: '', rarity: '', condition: 'Near Mint', quantity: 1, notes: '' });
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);
            const deferredPromptRef = useRef(null);
            const tesseractWorkerRef = useRef(null);

            useEffect(() => {
                loadCards();
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPromptRef.current = e; setShowInstallPrompt(true); });
                return () => { tesseractWorkerRef.current?.terminate(); };
            }, []);

            // --- NEW, ROBUST useEFFECT FOR CAMERA LOGIC ---
            useEffect(() => {
                const startCamera = async () => {
                    try {
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            throw new Error('Camera API not supported.');
                        }
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                        });

                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            streamRef.current = stream;
                        }
                    } catch (err) {
                        console.error("Camera Error:", err);
                        let msg = 'Could not access the camera. Please check your browser settings and refresh.';
                        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                            msg = 'Camera permission was denied. You must grant permission in your browser settings.';
                        }
                        alert(msg);
                        setView('collection'); // Go back on error
                    }
                };

                const stopCamera = () => {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                        streamRef.current = null;
                    }
                };

                if (view === 'camera') {
                    startCamera();
                }

                // This cleanup function is crucial. It runs when the component unmounts.
                return () => {
                    stopCamera();
                };
            }, [view]); // This effect runs only when the `view` state changes.

            const handleInstallClick = async () => { if (!deferredPromptRef.current) return; deferredPromptRef.current.prompt(); const { outcome } = await deferredPromptRef.current.userChoice; if (outcome === 'accepted') setShowInstallPrompt(false); deferredPromptRef.current = null; };
            const loadCards = async () => { try { const result = await localStorage.getItem('pokemon-cards'); if (result) setCards(JSON.parse(result)); } catch (error) {} };
            const saveAllCards = async (allCards) => { try { localStorage.setItem('pokemon-cards', JSON.stringify(allCards)); } catch (error) {} };
            const resetForm = () => { setFormData({ name: '', set: '', number: '', rarity: '', condition: 'Near Mint', quantity: 1, notes: '' }); setCapturedImage(null); setShowAddForm(false); setEditingCard(null); setIsAnalyzing(false); setOcrStatus(''); };
            
            const runOCR = async (imageData) => {
                try {
                    setOcrStatus('Initializing OCR engine (this may take a moment)...');
                    const worker = tesseractWorkerRef.current || await Tesseract.createWorker({ logger: m => setOcrStatus(m.status + ` (${Math.round(m.progress * 100)}%)`) });
                    tesseractWorkerRef.current = worker;
                    
                    const img = new Image();
                    img.src = imageData;
                    await new Promise(resolve => img.onload = resolve);

                    const cropRectangle = { left: img.width * 0.04, top: img.height * 0.88, width: img.width * 0.25, height: img.height * 0.10 };

                    setOcrStatus('Reading card number...');
                    const { data: { text } } = await worker.recognize(imageData, { rectangle: cropRectangle });
                    
                    setOcrStatus('Parsing result...');
                    const match = text.match(/\b(\d{1,3}\s?\/\s?\d{1,3})\b/);
                    if (match && match[0]) {
                        const cleanedNumber = match[0].replace(/\s/g, '');
                        setFormData(prev => ({ ...prev, number: cleanedNumber }));
                        setOcrStatus('Success! Please enter the Pokémon name to get full details.');
                    } else {
                        throw new Error('Could not read the card number. Please try again or enter it manually.');
                    }
                } catch (error) {
                    console.error("OCR Error:", error);
                    setOcrStatus(`Error: ${error.message}`);
                }
            };
            
            const capturePhoto = async () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (video && canvas) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = canvas.toDataURL('image/png');
                    setCapturedImage(imageData);
                    setView('collection'); // This will trigger the useEffect cleanup to stop the camera
                    setShowAddForm(true);
                    await runOCR(imageData);
                }
            };

            const getCardDetails = async () => {
                if (!formData.name || !formData.number) { alert("Please provide both a name and a number."); return; }
                setIsAnalyzing(true);
                try {
                    const response = await fetch("/api/analyze", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ cardName: formData.name, numberString: formData.number })
                    });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error || "Failed to get card details."); }
                    const details = await response.json();
                    setFormData(prev => ({ ...prev, ...details }));
                } catch (error) {
                    alert(`Error: ${error.message}`);
                } finally {
                    setIsAnalyzing(false);
                }
            };
            
            const handleAddCard = async () => {
                if (!formData.name || !formData.set) { alert('Please get card details first.'); return; }
                const newCard = { id: Date.now().toString(), ...formData, image: capturedImage, dateAdded: new Date().toISOString() };
                const updatedCards = [...cards, newCard];
                setCards(updatedCards);
                await saveAllCards(updatedCards);
                resetForm();
            };

            const handleUpdateCard = async () => {
                if (!formData.name) { alert('Please enter a card name'); return; }
                const updatedCard = { ...editingCard, ...formData };
                const updatedCards = cards.map(card => card.id === editingCard.id ? updatedCard : card );
                setCards(updatedCards);
                await saveAllCards(updatedCards);
                setSelectedCard(updatedCard);
                setEditingCard(null);
                resetForm();
            };

            const startEditCard = (card) => { setSelectedCard(null); setEditingCard(card); setFormData({ ...card }); setShowAddForm(true); };
            const handleDeleteCard = async (cardId) => { if (confirm('Are you sure you want to delete this card?')) { const updatedCards = cards.filter(card => card.id !== cardId); setCards(updatedCards); await saveAllCards(updatedCards); setSelectedCard(null); } };
            const filteredCards = cards.filter(card => card.name.toLowerCase().includes(searchTerm.toLowerCase()) || card.set.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
                    <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg sticky top-0 z-10">
                        <h1 className="text-2xl font-bold flex items-center gap-2"><Grid3x3 s={28} /> Pokemon Card Tracker</h1>
                        <p className="text-sm text-blue-100 mt-1 flex items-center gap-1"><Sparkles s={14} /> On-Device OCR • {cards.length} cards</p>
                    </div>
                    {showInstallPrompt && ( <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 flex items-center justify-between"><div className="flex items-center gap-3"><Grid3x3 s={24} /><div><p className="font-semibold">Install App</p><p className="text-xs text-blue-100">Add to home screen</p></div></div><div className="flex gap-2"><button onClick={() => setShowInstallPrompt(false)} className="px-3 py-1 text-sm">Later</button><button onClick={handleInstallClick} className="px-4 py-1 bg-white text-blue-600 rounded-lg text-sm font-semibold">Install</button></div></div> )}

                    {view === 'camera' && ( <div className="relative h-screen bg-black"><video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" /><canvas ref={canvasRef} className="hidden" /><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="border-4 border-white border-dashed rounded-lg w-4/5 max-w-md aspect-[2.5/3.5] opacity-50"></div></div><div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black to-transparent"><div className="flex justify-center gap-4"><button onClick={() => setView('collection')} className="px-6 py-3 bg-gray-700 text-white rounded-full font-semibold">Cancel</button><button onClick={capturePhoto} className="px-8 py-3 bg-blue-600 text-white rounded-full font-semibold flex items-center gap-2"><Camera s={20} /> Capture</button></div></div></div> )}
                    
                    {view === 'collection' && (
                        <div className="p-4 pb-24">
                            {selectedCard ? (
                                <div className="fixed inset-0 bg-white z-50 animate-fade-in"><div className="p-4 bg-gray-50 border-b"><button onClick={() => setSelectedCard(null)} className="flex items-center gap-2 text-blue-600 font-semibold"><ArrowLeft s={20} /> Back to Collection</button></div><div className="p-4"><img src={selectedCard.image} alt={selectedCard.name} className="w-full rounded-xl shadow-lg mb-4" /><h2 className="text-3xl font-bold text-gray-800">{selectedCard.name}</h2><p className="text-lg text-gray-600">{selectedCard.set}</p><div className="mt-4 grid grid-cols-2 gap-4 text-sm"><div className="bg-gray-100 p-3 rounded-lg"><p className="font-semibold text-gray-800">Card Number</p><p className="text-gray-600">{selectedCard.number || 'N/A'}</p></div><div className="bg-gray-100 p-3 rounded-lg"><p className="font-semibold text-gray-800">Rarity</p><p className="text-gray-600">{selectedCard.rarity || 'N/A'}</p></div><div className="bg-gray-100 p-3 rounded-lg"><p className="font-semibold text-gray-800">Condition</p><p className="text-gray-600">{selectedCard.condition}</p></div><div className="bg-gray-100 p-3 rounded-lg"><p className="font-semibold text-gray-800">Quantity</p><p className="text-gray-600">{selectedCard.quantity}</p></div></div><div className="mt-4 bg-gray-100 p-3 rounded-lg"><p className="font-semibold text-gray-800 text-sm">Notes</p><p className="text-gray-600 whitespace-pre-wrap">{selectedCard.notes || 'No additional notes.'}</p></div><div className="mt-6 flex gap-3"><button onClick={() => startEditCard(selectedCard)} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-semibold flex items-center justify-center gap-2"><Edit2 s={18} /> Edit</button><button onClick={() => handleDeleteCard(selectedCard.id)} className="flex-1 py-3 bg-red-600 text-white rounded-lg font-semibold flex items-center justify-center gap-2"><Trash2 s={18} /> Delete</button></div></div></div>
                            ) : (
                                <><div className="mb-4"><div className="relative"><Search s={20} c="absolute left-3 top-3 text-gray-400" /><input type="text" placeholder="Search cards..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg" /></div></div>
                                {filteredCards.length === 0 ? ( <div className="text-center py-16"><Grid3x3 s={64} c="mx-auto text-gray-300 mb-4" /><p className="text-gray-500 text-lg mb-2">No cards in your collection yet</p><p className="text-gray-400">Tap the camera button to add your first card!</p></div> ) : (
                                <div className="grid grid-cols-2 gap-4">{filteredCards.map((card) => ( <div key={card.id} onClick={() => setSelectedCard(card)} className="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer active:scale-95 transition-transform"><img src={card.image} alt={card.name} className="w-full h-48 object-cover" /><div className="p-3"><h3 className="font-bold text-gray-800 truncate">{card.name}</h3><p className="text-sm text-gray-600">{card.set}</p><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mt-2 inline-block">Qty: {card.quantity}</span></div></div> ))}</div> )}
                                </>
                            )}
                        </div>
                    )}

                    {showPermissionModal && ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl max-w-md w-full p-6"><div className="flex items-center gap-3 mb-4"><div className="p-3 bg-blue-100 rounded-full"><Camera s={24} c="text-blue-600" /></div><h2 className="text-xl font-bold">Camera Access Required</h2></div><p className="text-gray-600 mb-6">This app needs camera access to scan your cards.</p><div className="flex gap-3"><button onClick={() => setShowPermissionModal(false)} className="flex-1 px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold">Cancel</button><button onClick={() => { setShowPermissionModal(false); setView('camera'); }} className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold">Allow Camera</button></div></div></div> )}
                    {showAddForm && ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50"><div className="bg-white rounded-t-3xl w-full max-h-[90vh] overflow-y-auto p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">{editingCard ? 'Edit Card' : 'Add Card Details'}</h2><button onClick={resetForm} className="p-2 hover:bg-gray-100 rounded-full"><X s={24} /></button></div>{capturedImage && !editingCard && (<img src={capturedImage} alt="Captured" className="w-full h-48 object-cover rounded-lg mb-4" />)}{ocrStatus && <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">{ocrStatus}</div>}<div className="space-y-4"><div><label className="block text-sm font-semibold text-gray-700 mb-1">Card Number (from OCR)</label><input type="text" value={formData.number} onChange={(e) => setFormData({...formData, number: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg" placeholder="e.g., 130/203" /></div><div><label className="block text-sm font-semibold text-gray-700 mb-1">Card Name *</label><input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg" placeholder="e.g., Lombre" /></div>{(!formData.set && !editingCard) && ( <button onClick={getCardDetails} disabled={isAnalyzing} className="w-full py-3 bg-green-600 text-white rounded-lg font-semibold flex items-center justify-center gap-2 disabled:opacity-50">{isAnalyzing ? <Loader2 s={20} c="animate-spin" /> : <Search s={20} />} Get Card Details</button> )}<div><label className="block text-sm font-semibold text-gray-700 mb-1">Set</label><input type="text" value={formData.set} disabled className="w-full px-4 py-2 bg-gray-100 border-2 border-gray-200 rounded-lg" /></div><div><label className="block text-sm font-semibold text-gray-700 mb-1">Rarity</label><input type="text" value={formData.rarity} disabled className="w-full px-4 py-2 bg-gray-100 border-2 border-gray-200 rounded-lg" /></div><div><label className="block text-sm font-semibold text-gray-700 mb-1">Condition</label><select value={formData.condition} onChange={(e) => setFormData({...formData, condition: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg"><option>Near Mint</option><option>Excellent</option><option>Good</option><option>Played</option><option>Poor</option></select></div><div><label className="block text-sm font-semibold text-gray-700 mb-1">Quantity</label><input type="number" min="1" value={formData.quantity} onChange={(e) => setFormData({...formData, quantity: parseInt(e.target.value) || 1})} className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg" /></div><div><label className="block text-sm font-semibold text-gray-700 mb-1">Notes</label><textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg" rows="3" placeholder="e.g., Illustrator details..."/></div><button onClick={editingCard ? handleUpdateCard : handleAddCard} className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold flex items-center justify-center gap-2"><Check s={20} />{editingCard ? 'Update Card' : 'Add to Collection'}</button></div></div></div> )}
                    {view === 'collection' && !showAddForm && !selectedCard && ( <button onClick={() => setShowPermissionModal(true)} className="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-transform z-40"><Camera s={28} /></button> )}
                </div>
            );
        }

        ReactDOM.render(<PokemonCardTracker />, document.getElementById('root'));
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>